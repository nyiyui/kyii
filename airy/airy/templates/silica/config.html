{% extends "silica/base.html" %}
{% import "silica/macros.html" as macros %}

{% block title %}設定{% endblock %}

{% block content %}
	<h2>{{ _("認証設定") }}</h2>
	<form action="/config/ax" method="post">
		<h3>{{ _("認証パス") }}</h3>
		<table id="ap">
			<tr>
				<th rowspan="2">ID</th>
				<th rowspan="2">名前</th>
				<th colspan="{{ current_user.af | length }}">認証方法</th>
			</tr>
			<tr>
				{% for af in current_user.af %}
					<td>
						{{ af.name }}
					</td>
				{% endfor %}
			</tr>
			{% for ap in current_user.ap %}
				<tr id="ap-{{ ap.id }}">
					<td>{{ ap.id }}</td>
					<td>
						<input type="text" name="ap_{{ ap.id }}_name" value="{{ ap.name }}" />
					</td>
					{% for af in current_user.af %}
						<td>
							<input
								type="checkbox"
								name="ap_{{ ap.id }}_req_{{ af.id }}"
								{% if af in ap.reqs %}checked{% endif %}
								value="{{ af.id }}"
							/>
						</td>
					{% endfor %}
				</tr>
			{% endfor %}
		</table>
		<h3>{{ _("認証方法") }}</h3>
		<table id="af">
			<tr>
				<th>ID</th>
				<th>名前</th>
				<th>型</th>
				<th>設定</th>
				<th>状態</th>
				<th>編集</th>
			</tr>
			{% for af in current_user.af %}
				{% if af.gen_done %}
					<tr id="af-{{ af.id }}">
						<td>{{ af.id }}</td>
						<td>
							<input type="text" name="af_{{ af.id }}_name" value="{{ af.name }}" />
						</td>
						<td>
							<!--
							<select name="af_{{ af.id }}_verifier">
								<option value="pw"       {{ 'selected' if af.verifier == "pw" }}>{{ _("パスワード") }}</option>
								<option value="otp_totp" {{ 'selected' if af.verifier == "otp_totp" }}>{{ _("TOTP") }}</option>
								<option value="webauthn" {{ 'selected' if af.verifier == "webauthn" }}>{{ _("WebAuthn") }}</option>
								<option value="limited"  {{ 'selected' if af.verifier == "limited" }}>{{ _("回数制限") }}</option>
								<option value="remote"   {{ 'selected' if af.verifier == "remote" }}>{{ _("遠隔認証") }}</option>
							</select>
							-->
							{{ af.verifier }}
						</td>
						<td>
							{% if af.verifier == "pw" %}
								{% if af.params.compat == 'django_pbkdf2_sha256' %}
									{{ _("※Django PBKDF2/SHA256対応") }}
								{% endif %}
							{% elif af.verifier == "limited" %}
								{{ _("%(limit)sまで", af.params.limit) }}
							{% endif %}
						</td>
						<td>
							{% if af.verifier == "limited" %}
								{{ _("%(used)s回使用", af.params.used) }}
							{% endif %}
						</td>
						<td>
							<!-- TODO: use url_for -->
							<a href="/config/af/{{ af.id }}/edit">
								編集
							</a>
						</td>
					</tr>
				{% endif %}
			{% endfor %}
		</table>
		{{ macros.form_csrf() }}
		<input type="submit" value="保存" class="Bsuccess" />
	</form>
	<hr />
	<h2>プロフィール</h2>
	<form action="/config/profile" method="post">
		<label>
			ID
			<input type="text" disabled value="{{ current_user.id }}" />
		</label>
		{{ form.hidden_tag() }}
		{{ form.name.label }} {{ form.name }}
		{{ form.handle.label }} {{ form.handle }}
		<div class="errors">
			<ul>
				{% for error in form.errors.slug %}
					<li>{{ error }}</li>
				{% endfor %}
			</ul>
		</div>
		<input type="submit" value="{{ _('保存') }}" class="Bsuccess" />
	</form>
{% endblock %}
